# Ethereum Blocks from the Ethereum Mainnet

- The code here produces two streams of Ethereum blocks: `blocks-stable` and `blocks-unstable`. The unstable stream provides blocks in real time and will frequently fork. The stable stream provide blocks at a 12 block delay and is unlikely to ever fork.
- When a fork occurs in `blocks-unstable`, the forked block(s) will quickly be overriden by the new branch, but there will be a brief inconsistency (on the order of seconds). The streaming view and BigQuery datasets will continue to contain the forked blocks, but with a lower data `@meta.timestamp` (which is the time the record was written to Beneath -- don't mistake it for the *block* timestamp, which is when a block was mined).

The streams are deployed as root streams at:

- [beneath.dev/beneath/ethereum/blocks-stable](https://beneath.dev/beneath/ethereum/blocks-stable)
- [beneath.dev/beneath/ethereum/blocks-unstable](https://beneath.dev/beneath/ethereum/blocks-unstable)

### Developing the stream

The data in these streams are generated by the `fetch_blocks.py` python script, which we run in Kubernetes in a namespace called `models`.

To set yourself up for development:

    python3 -m venv .venv
    source .venv/bin/activate
    pip install -r requirements.txt

To rebuild the Docker image:

    docker build -t gcr.io/beneath/ethereum-blocks:latest .
    docker push gcr.io/beneath/ethereum-blocks:latest
   
To create the Beneath project where the streams are stored:

    beneath project create beneath/ethereum

To deploy to Kubernetes:

    kubectl apply -f kube.yaml -n models

Important: There must ever only be one replica of the script running at a time. (Running multiple wouldn't hurt consistency, but would cause duplicates to appear in the streaming view and in the data warehouses.)

The secret used to connect to Beneath was issued with:

    python ./fetch-blocks.py stage beneath/ethereum/fetch-blocks --read-quota-mb 10000 --write-quota-mb 10000
    beneath service issue-secret beneath/ethereum/fetch-blocks --description kubernetes

And applied to Kubernetes with:

    kubectl create secret generic ethereum-blocks -n models --from-literal secret=SECRET
