#!/usr/bin/env python
import argparse
import json
import glob
import os

from beneath import config
from beneath.client import Client

def str2bool(v):
    if isinstance(v, bool):
       return v
    if v.lower() in ('yes', 'true', 't', 'y', '1'):
        return True
    elif v.lower() in ('no', 'false', 'f', 'n', '0'):
        return False
    else:
        raise argparse.ArgumentTypeError('Boolean value expected.')

def get_client():
  return Client()

def auth(args):
  try:
    Client(secret=args.secret)
    config.write_secret(args.secret)
    print("You have authenticated successfully!")
  except:
    config.write_secret("")
    print("Your attempt to authenticate failed. Are you using an API secret generated in the Beneath web app?")


def project_list(args):
  # start client with the secret stored in .beneath/secret
  client = get_client()

  # submit GraphQL query to get the user's ID
  result = client.get_me()
  userID = result['userID']

  # submit GraphQL query to get the user's projects
  result = client.get_user_by_id(userID)
  projects = result['projects']

  # print out the projects to the user
  for project in projects:
    print(project['name'])
  return


def project_create(args):
  client = get_client()
  result = client.create_project(
    name=args.name,
    display_name=args.display_name,
    description=args.description,
    site_url=args.site_url,
    photo_url=args.photo_url,
  )
  pretty_print_graphql_result(result, [])
  

def project_update(args):
  client = get_client()
  project = client.get_project_by_name(args.name)
  result = client.update_project(
    project_id=project['projectID'],
    display_name=args.display_name,
    description=args.description,
    site_url=args.site_url,
    photo_url=args.photo_url,
  )
  pretty_print_graphql_result(result, [])


def project_delete(args):
  client = get_client()
  project = client.get_project_by_name(args.name)
  result = client.delete_project(project_id=project['projectID'])
  pretty_print_graphql_result(result, [])


def stream_list(args):
  # start client with the secret stored in .beneath/secret
  client = get_client()

  # submit GraphQL query to get a project's streams
  result = client.get_project_by_name(args.project)
  streams = result['streams']

  # print out the streams to the user
  for streamname in streams:
      print(streamname['name'])

  if len(streams) == 0:
    print("There are no streams currently in this project")
  return

def model_init(args):
  print("init")
  print(args)
  # client = get_client()
  pass

def model_sim(args):
  print("model_sim")
  print(args)
  # client = get_client()
  pass

def model_stage(args):
  # read config
  with open("config.json", "r") as f:
    config = json.load(f)

  # read schemas
  def _read_schema(path):
    with open(path, "r") as f:
      return f.read()
  schemas = [_read_schema(p) for p in glob.glob("schemas/*.graphql")]

  # get client
  client = get_client()

  # get project
  result = client.get_project_by_name(config.get("project", None))
  project_id = result['projectID']

  # get input stream IDs
  input_stream_ids = []
  for dep in config.get("dependencies", []):
    project, stream = dep.split("/")
    details = client.get_stream_details(project, stream)
    input_stream_ids.append(details["streamID"])
  
  # stage model
  name = config.get("name", None)
  if args.update:
    model = client.get_model_details(project, name)
    result = client.update_model(
      model_id=model["modelID"],
      source_url=config.get("source_url", None),
      description=config.get("description", None),
      input_stream_ids=input_stream_ids,
      output_stream_schemas=schemas,
    )
  else:
    result = client.create_model(
      project_id=project_id,
      name=name,
      kind=config.get("kind", None),
      source_url=config.get("source_url", None),
      description=config.get("description", None),
      input_stream_ids=input_stream_ids,
      output_stream_schemas=schemas,
    )

  # print out model details
  pretty_print_graphql_result(result, [
  ])

def model_deploy(args):
  print("model_deploy")
  print(args)
  # client = get_client()
  pass

def stream_create_ext(args):
  # start client with the secret stored in .beneath/secret
  client = get_client()

  # submit GraphQL query to get the projectID from the user-supplied projectName
  result = client.get_project_by_name(args.project)
  project_id = result['projectID']
  
  # read schema from the user-supplied file
  with open(args.file, "r") as f:
    schema = f.read()
  
  # submit GraphQL mutation to create an external stream
  manual = args.manual
  result = client.create_external_stream(project_id=project_id, schema=schema, manual=manual)
  
  # print out the stream's details to the user
  pretty_print_graphql_result(result, [
    "name",
    "description",
    "external",
    "batch",
    "manual",
    "project",
    "keyFields",
  ])

def stream_update_ext(args):
  # start client with the secret stored in .beneath/secret
  client = get_client()

  # get stream id
  result = client.get_stream_details(project_name=args.project, stream_name=args.stream)
  stream_id = result['streamID']

  # read schema from the user-supplied file
  schema = None
  if args.file:
    with open(args.file, "r") as f:
      schema = f.read()

  # submit GraphQL mutation to update stream
  manual = args.manual
  result = client.update_external_stream(stream_id, schema, manual)
  
  # print out the stream's details to the user 
  pretty_print_graphql_result(result, [
    "name",
    "description",
    "external",
    "batch",
    "manual",
    "project",
    "keyFields",
  ])

def pretty_print_graphql_result(result, fields=[]):
  if len(fields) == 0:
    selected = result
  else:
    selected = { k: v for k, v in result.items() if k in fields }
  pretty = json.dumps(selected, indent=True)
  print(pretty)

if __name__ == '__main__':
  parser = argparse.ArgumentParser()
  _root = parser.add_subparsers()

  # auth parser
  _auth = _root.add_parser('auth')
  _auth.set_defaults(func=auth)
  _auth.add_argument('secret', type=str)

  # project parser and subparsers
  _project = _root.add_parser('project').add_subparsers()

  _project_list = _project.add_parser('list')
  _project_list.set_defaults(func=project_list)

  _project_create = _project.add_parser('create')
  _project_create.set_defaults(func=project_create)
  _project_create.add_argument('name', type=str)
  _project_create.add_argument('--display-name', type=str, required=True)
  _project_create.add_argument('--description', type=str)
  _project_create.add_argument('--site-url', type=str)
  _project_create.add_argument('--photo-url', type=str)

  _project_update = _project.add_parser('update')
  _project_update.set_defaults(func=project_update)
  _project_update.add_argument('name', type=str)
  _project_update.add_argument('--display-name', type=str, required=True)
  _project_update.add_argument('--description', type=str)
  _project_update.add_argument('--site-url', type=str)
  _project_update.add_argument('--photo-url', type=str)

  _project_delete = _project.add_parser('delete')
  _project_delete.set_defaults(func=project_delete)
  _project_delete.add_argument('name', type=str)

  # model parser and subparsers
  _model = _root.add_parser('model').add_subparsers()

  _model_init = _model.add_parser('init')
  _model_init.set_defaults(func=model_init)
  _model_init.add_argument('model', type=str)
  _model_init.add_argument('--project', type=str, required=True)

  _model_sim = _model.add_parser('simulate')
  _model_sim.set_defaults(func=model_sim)
  _model_sim.add_argument('--sample-size', type=int)

  _model_stage = _model.add_parser('stage')
  _model_stage.set_defaults(func=model_stage)
  _model_stage.add_argument('--update', type=str2bool, nargs='?', const=True, default=False)

  _model_deploy = _model.add_parser('deploy')
  _model_deploy.set_defaults(func=model_deploy)
  _model_deploy.add_argument('--update', type=str)

  # stream parser and subparsers
  _stream = _root.add_parser('stream').add_subparsers()

  _stream_list = _stream.add_parser('list')
  _stream_list.set_defaults(func=stream_list)
  _stream_list.add_argument('--project', type=str, required=True)

  _stream_create_ext = _stream.add_parser('create-root')
  _stream_create_ext.set_defaults(func=stream_create_ext)
  _stream_create_ext.add_argument('-f', '--file', type=str, required=True, help="this file should contain the GraphQL schema for the stream you would like to create")
  _stream_create_ext.add_argument('--project', type=str, required=True)
  _stream_create_ext.add_argument('--manual', type=str2bool, nargs='?', const=True, default=False)

  _stream_update_ext = _stream.add_parser('update-root')
  _stream_update_ext.set_defaults(func=stream_update_ext)
  _stream_update_ext.add_argument('stream', type=str)
  _stream_update_ext.add_argument('-f', '--file', type=str, required=True, help="This file should contain the stream's schema and an updated description. Only the description should change, the schema itself should not change.")
  _stream_update_ext.add_argument('--project', type=str, required=True)
  _stream_update_ext.add_argument('--manual', type=str2bool, nargs='?', const=True, default=False)

  # parse the args and call the relevant function
  args = parser.parse_args()
  try:
    func = args.func
  except AttributeError:
    parser.error("too few arguments")
  func(args)

